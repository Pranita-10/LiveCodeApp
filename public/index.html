<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live Code Sharing App—</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&family=Syne:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #111118;
    --surface2: #18181f;
    --border: #2a2a35;
    --accent: #00ff88;
    --accent2: #7c3aed;
    --accent3: #f59e0b;
    --text: #e2e2f0;
    --text-muted: #6b6b80;
    --error: #ff4d6a;
    --mono: 'JetBrains Mono', monospace;
    --display: 'Syne', sans-serif;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }
  
  body {
    font-family: var(--mono);
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  /* ── LANDING SCREEN ── */
  #landing {
    position: fixed;
    inset: 0;
    background: var(--bg);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
    overflow: hidden;
  }

  .landing-grid {
    position: absolute;
    inset: 0;
    background-image:
      linear-gradient(var(--border) 1px, transparent 1px),
      linear-gradient(90deg, var(--border) 1px, transparent 1px);
    background-size: 40px 40px;
    opacity: 0.3;
    animation: gridShift 20s linear infinite;
  }

  @keyframes gridShift {
    from { transform: translate(0, 0); }
    to { transform: translate(40px, 40px); }
  }

  .landing-glow {
    position: absolute;
    width: 600px; height: 600px;
    background: radial-gradient(circle, rgba(0,255,136,0.06) 0%, transparent 70%);
    border-radius: 50%;
    animation: glowPulse 4s ease-in-out infinite;
  }

  @keyframes glowPulse {
    0%, 100% { transform: scale(1); opacity: 0.5; }
    50% { transform: scale(1.2); opacity: 1; }
  }

  .landing-card {
    position: relative;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 2px;
    padding: 48px;
    width: 460px;
    animation: cardIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) both;
  }

  @keyframes cardIn {
    from { transform: translateY(30px) scale(0.95); opacity: 0; }
    to { transform: translateY(0) scale(1); opacity: 1; }
  }

  .logo {
    font-family: var(--display);
    font-size: 32px;
    font-weight: 800;
    letter-spacing: -1px;
    margin-bottom: 6px;
  }

  .logo span {
    color: var(--accent);
    text-shadow: 0 0 20px rgba(0,255,136,0.5);
  }

  .tagline {
    color: var(--text-muted);
    font-size: 12px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    margin-bottom: 36px;
  }

  .name-field {
    margin-bottom: 24px;
  }

  label {
    display: block;
    font-size: 11px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 8px;
  }

  input[type="text"] {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: var(--mono);
    font-size: 14px;
    padding: 10px 14px;
    outline: none;
    transition: border-color 0.2s;
    border-radius: 2px;
  }

  input[type="text"]:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(0,255,136,0.08);
  }

  .divider {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 28px 0;
    color: var(--text-muted);
    font-size: 11px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }

  .divider::before, .divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  .btn {
    width: 100%;
    padding: 12px;
    font-family: var(--mono);
    font-size: 13px;
    font-weight: 500;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    cursor: pointer;
    border: 1px solid var(--border);
    border-radius: 2px;
    transition: all 0.15s;
  }

  .btn-primary {
    background: var(--accent);
    color: #000;
    border-color: var(--accent);
    text-shadow: none;
  }

  .btn-primary:hover {
    background: #00e07a;
    box-shadow: 0 0 20px rgba(0,255,136,0.3);
  }

  .btn-secondary {
    background: transparent;
    color: var(--text);
  }

  .btn-secondary:hover {
    background: var(--surface2);
    border-color: var(--text-muted);
  }

  .join-row {
    display: flex;
    gap: 8px;
    margin-top: 0;
  }

  .join-row input {
    flex: 1;
    text-transform: uppercase;
    letter-spacing: 0.2em;
  }

  .join-row .btn {
    width: auto;
    padding: 10px 18px;
    white-space: nowrap;
  }

  #error-msg {
    color: var(--error);
    font-size: 12px;
    margin-top: 12px;
    min-height: 16px;
    display: none;
  }

  /* ── APP SHELL ── */
  #app {
    display: none;
    flex-direction: column;
    height: 100vh;
  }

  /* ── TOPBAR ── */
  .topbar {
    height: 48px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 16px;
    gap: 16px;
    flex-shrink: 0;
  }

  .topbar-logo {
    font-family: var(--display);
    font-weight: 800;
    font-size: 18px;
    letter-spacing: -0.5px;
    color: var(--accent);
  }

  .room-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--surface2);
    border: 1px solid var(--border);
    padding: 4px 12px;
    font-size: 12px;
    letter-spacing: 0.15em;
    border-radius: 2px;
  }

  .room-badge .dot {
    width: 6px; height: 6px;
    background: var(--accent);
    border-radius: 50%;
    box-shadow: 0 0 6px var(--accent);
    animation: blink 2s ease-in-out infinite;
  }

  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  .copy-btn {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    font-size: 10px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    font-family: var(--mono);
    padding: 2px 6px;
    transition: color 0.2s;
  }

  .copy-btn:hover { color: var(--accent); }

  .lang-select {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: var(--mono);
    font-size: 12px;
    padding: 5px 10px;
    outline: none;
    cursor: pointer;
    border-radius: 2px;
    margin-left: auto;
  }

  .lang-select:focus { border-color: var(--accent); }

  .users-area {
    display: flex;
    gap: 6px;
    align-items: center;
  }

  .user-pill {
    font-size: 10px;
    padding: 3px 8px;
    border-radius: 999px;
    border: 1px solid;
    letter-spacing: 0.05em;
  }

  .leave-btn {
    margin-left: 8px;
    background: none;
    border: 1px solid var(--border);
    color: var(--text-muted);
    font-family: var(--mono);
    font-size: 11px;
    padding: 5px 12px;
    cursor: pointer;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    border-radius: 2px;
    transition: all 0.15s;
  }

  .leave-btn:hover { border-color: var(--error); color: var(--error); }

  /* ── MAIN LAYOUT ── */
  .main {
    display: flex;
    flex: 1;
    overflow: hidden;
  }

  /* ── EDITOR PANE ── */
  .editor-pane {
    flex: 1;
    display: flex;
    flex-direction: column;
    position: relative;
    overflow: hidden;
  }

  .editor-header {
    padding: 8px 16px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 11px;
    color: var(--text-muted);
    letter-spacing: 0.05em;
    flex-shrink: 0;
  }

  .editor-header .tab {
    color: var(--text);
    padding: 2px 0;
    border-bottom: 2px solid var(--accent);
  }

  #typing-indicator {
    font-size: 11px;
    color: var(--accent);
    margin-left: auto;
    min-height: 16px;
    transition: opacity 0.3s;
  }

  .editor-wrapper {
    flex: 1;
    display: flex;
    overflow: hidden;
    position: relative;
  }

  .line-numbers {
    width: 50px;
    background: var(--surface);
    border-right: 1px solid var(--border);
    padding: 12px 0;
    text-align: right;
    font-size: 13px;
    line-height: 1.6;
    color: var(--text-muted);
    overflow: hidden;
    --user-select: none;
    flex-shrink: 0;
  }

  .line-numbers span {
    display: block;
    padding-right: 12px;
    height: 20.8px;
  }

  #code-editor {
    flex: 1;
    background: var(--bg);
    color: var(--text);
    font-family: var(--mono);
    font-size: 13px;
    line-height: 1.6;
    padding: 12px 16px;
    border: none;
    outline: none;
    resize: none;
    tab-size: 2;
    white-space: pre;
    overflow-wrap: normal;
    overflow: auto;
    caret-color: var(--accent);
  }

  #code-editor::selection {
    background: rgba(0,255,136,0.15);
  }

  /* ── OUTPUT PANE ── */
  .output-pane {
    height: 180px;
    flex-shrink: 0;
    border-top: 1px solid var(--border);
    display: flex;
    flex-direction: column;
  }

  .output-header {
    padding: 6px 16px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 11px;
    color: var(--text-muted);
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }

  .run-btn {
    background: none;
    border: 1px solid var(--accent);
    color: var(--accent);
    font-family: var(--mono);
    font-size: 11px;
    padding: 3px 12px;
    cursor: pointer;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    border-radius: 2px;
    margin-left: auto;
    transition: all 0.15s;
  }

  .run-btn:hover {
    background: var(--accent);
    color: #000;
  }

  .clear-btn {
    background: none;
    border: none;
    color: var(--text-muted);
    font-family: var(--mono);
    font-size: 11px;
    cursor: pointer;
    letter-spacing: 0.05em;
  }

  .clear-btn:hover { color: var(--error); }

  #output {
    flex: 1;
    background: var(--surface);
    padding: 8px 16px;
    overflow-y: auto;
    font-size: 12px;
    line-height: 1.6;
  }

  .out-line { margin-bottom: 2px; }
  .out-line.error { color: var(--error); }
  .out-line.info { color: var(--text-muted); }
  .out-line.success { color: var(--accent); }

  /* ── SIDEBAR ── */
  .sidebar {
    width: 260px;
    flex-shrink: 0;
    background: var(--surface);
    border-left: 1px solid var(--border);
    display: flex;
    flex-direction: column;
  }

  .sidebar-section {
    border-bottom: 1px solid var(--border);
  }

  .sidebar-title {
    padding: 10px 16px;
    font-size: 10px;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--text-muted);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .sidebar-count {
    background: var(--accent2);
    color: white;
    font-size: 9px;
    padding: 1px 6px;
    border-radius: 999px;
  }

  #users-list {
    padding: 6px 12px 12px;
  }

  .user-entry {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 6px 8px;
    border-radius: 2px;
    font-size: 12px;
    transition: background 0.15s;
  }

  .user-entry:hover { background: var(--surface2); }

  .user-avatar {
    width: 24px; height: 24px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    font-weight: 700;
    flex-shrink: 0;
  }

  .user-name { flex: 1; }
  .user-you { color: var(--text-muted); font-size: 10px; }

  /* ── CHAT ── */
  .chat-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  #chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 8px 12px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .chat-msg {
    font-size: 12px;
    line-height: 1.5;
  }

  .chat-msg-header {
    display: flex;
    gap: 8px;
    align-items: baseline;
    margin-bottom: 2px;
  }

  .chat-msg-name {
    font-weight: 500;
    font-size: 11px;
  }

  .chat-msg-time {
    color: var(--text-muted);
    font-size: 10px;
  }

  .chat-msg-text {
    color: var(--text);
    padding-left: 2px;
  }

  .chat-msg.system .chat-msg-text {
    color: var(--text-muted);
    font-style: italic;
    font-size: 11px;
  }

  .chat-input-area {
    display: flex;
    gap: 8px;
    padding: 10px 12px;
    border-top: 1px solid var(--border);
  }

  .chat-input-area input {
    flex: 1;
    font-size: 12px;
    padding: 7px 10px;
  }

  .send-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: var(--mono);
    font-size: 11px;
    padding: 7px 14px;
    cursor: pointer;
    border-radius: 2px;
    transition: all 0.15s;
  }

  .send-btn:hover { border-color: var(--accent); color: var(--accent); }

  /* scrollbar */
  ::-webkit-scrollbar { width: 4px; height: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

  /* toast */
  #toast {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: var(--accent);
    color: #000;
    font-size: 12px;
    font-weight: 500;
    padding: 8px 20px;
    border-radius: 2px;
    opacity: 0;
    transition: all 0.3s;
    pointer-events: none;
    z-index: 999;
    letter-spacing: 0.05em;
  }

  #toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  .status-dot {
    width: 5px; height: 5px;
    border-radius: 50%;
    display: inline-block;
  }

  .status-dot.online { background: var(--accent); }
  .status-dot.offline { background: var(--error); }
</style>
</head>
<body>

<!-- LANDING -->
<div id="landing">
  <div class="landing-grid"></div>
  <div class="landing-glow"></div>
  <div class="landing-card">
    <div class="logo">Live<span>Code</span></div>
    <div class="tagline">Live Coder</div>

    <div class="name-field">
      <label>Your Name</label>
      <input type="text" id="username-input" placeholder="e.g. ABC_XYZ" maxlength="20" autocomplete="off">
    </div>

    <button class="btn btn-primary" onclick="createRoom()">Create New Room</button>

    <div class="divider">or join existing</div>

    <div class="join-row">
      <input type="text" id="room-code-input" placeholder="HERE THE CODE" maxlength="8" autocomplete="off">
      <button class="btn btn-secondary" onclick="joinRoom()">Join</button>
    </div>

    <div id="error-msg"></div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <div class="topbar">
    <div class="topbar-logo">LiveCode</div>
    <div class="room-badge">
      <div class="dot"></div>
      <span id="room-id-display">------</span>
      <button class="copy-btn" onclick="copyRoomId()">copy</button>
    </div>
    <select class="lang-select" id="lang-select" onchange="changeLanguage(this.value)">
      <option value="javascript">JavaScript</option>
      <option value="python">Python</option>
      <option value="html">HTML</option>
      <option value="css">CSS</option>
      <option value="typescript">TypeScript</option>
      <option value="json">JSON</option>
      <option value="bash">Bash</option>
    </select>
    <div class="users-area" id="topbar-users"></div>
    <button class="leave-btn" onclick="leaveRoom()">LEAVE</button>
  </div>

  <div class="main">
    <!-- EDITOR -->
    <div class="editor-pane">
      <div class="editor-header">
        <span class="tab" id="file-tab">main.js</span>
        <span id="typing-indicator"></span>
      </div>
      <div class="editor-wrapper">
        <div class="line-numbers" id="line-numbers"></div>
    <textarea id="code-editor"
         spellcheck="false" 
         autocomplete="off" 
         autocorrect="off"
        autocapitalize="off">
    </textarea>
      </div>
      <div class="output-pane">
        <div class="output-header">
          Console
          <button class="run-btn" onclick="runCode()">▶ Run</button>
          <button class="clear-btn" onclick="clearOutput()">clear</button>
        </div>
        <div id="output"></div>
      </div>
    </div>

    <!-- SIDEBAR -->
    <div class="sidebar">
      <div class="sidebar-section">
        <div class="sidebar-title">
          Collaborators
          <span class="sidebar-count" id="user-count">1</span>
        </div>
        <div id="users-list"></div>
      </div>
      <div class="chat-area sidebar-section" style="border-bottom:none; flex:1; overflow:hidden;">
        <div class="sidebar-title">Chat</div>
        <div id="chat-messages"></div>
        <div class="chat-input-area">
          <input type="text" id="chat-input" placeholder="Message..." maxlength="200" onkeydown="chatKeydown(event)">
          <button class="send-btn" onclick="sendChat()">→</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
const USER_COLORS = ['#00ff88','#7c3aed','#f59e0b','#3b82f6','#ec4899','#06b6d4','#84cc16','#f97316'];
let ws, myId, myName, myRoomId;
let isUpdatingFromRemote = false;
let typingTimer;
let typingUsers = new Set();

function getColor(userId) {
  let h = 0;
  for (let i = 0; i < userId.length; i++) h = userId.charCodeAt(i) + ((h << 5) - h);
  return USER_COLORS[Math.abs(h) % USER_COLORS.length];
}

// ── WS CONNECTION ──
function connect() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(`${proto}//${location.host}`);

  ws.onopen = () => {};

  ws.onmessage = (e) => {
    const msg = JSON.parse(e.data);
    handleMessage(msg);
  };

  ws.onclose = () => {
    showToast('Disconnected. Reconnecting...');
    setTimeout(connect, 2000);
  };

  ws.onerror = () => {};
}

function send(data) {
  if (ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify(data));
  }
}

function handleMessage(msg) {
  switch (msg.type) {
    case 'connected':
      myId = msg.clientId;
      break;

    case 'room_joined': {
      myRoomId = msg.roomId;
      document.getElementById('room-id-display').textContent = msg.roomId;
      document.getElementById('landing').style.display = 'none';
      document.getElementById('app').style.display = 'flex';
      updateLangTab(msg.language);
      isUpdatingFromRemote = true;
      const editor = document.getElementById('code-editor');
      editor.value = msg.code;
      isUpdatingFromRemote = false;
      updateLineNumbers();
      updateUsers(msg.users);
      addSystemMsg(`You joined room ${msg.roomId}`);
      break;
    }

    case 'code_update':
      if (msg.userId !== myId) {
        isUpdatingFromRemote = true;
        const editor = document.getElementById('code-editor');
        const pos = editor.selectionStart;
        editor.value = msg.code;
        editor.selectionStart = editor.selectionEnd = pos;
        isUpdatingFromRemote = false;
        updateLineNumbers();
        showTypingIndicator(msg.userId);
      }
      break;

    case 'language_update':
      updateLangTab(msg.language);
      break;

    case 'user_joined':
      updateUsers(msg.users);
      addSystemMsg(`${msg.user.name} joined`);
      showToast(`${msg.user.name} joined`);
      break;

    case 'user_left':
      updateUsers(msg.users);
      addSystemMsg(`${msg.name} left`);
      break;

    case 'chat_message':
      addChatMsg(msg);
      break;

    case 'cursor_update':
      showTypingIndicator(msg.name);
      break;

    case 'error':
      showError(msg.message);
      break;
  }
}

// ── ROOM ACTIONS ──
function createRoom() {
  const name = getUsername();
  if (!name) return;
  myName = name;
  connect();
  ws.addEventListener('open', () => {
    send({ type: 'create_room', name });
  }, { once: true });
}

function joinRoom() {
  const name = getUsername();
  if (!name) return;
  const code = document.getElementById('room-code-input').value.trim().toUpperCase();
  if (!code) { showError('Enter a room code'); return; }
  myName = name;
  connect();
  ws.addEventListener('open', () => {
    send({ type: 'join_room', roomId: code, name });
  }, { once: true });
}

function leaveRoom() {
  send({ type: 'leave_room' });
  location.reload();
}

function getUsername() {
  const val = document.getElementById('username-input').value.trim();
  if (!val) { showError('Enter a display name'); return null; }
  return val;
}

function showError(msg) {
  const el = document.getElementById('error-msg');
  el.textContent = msg;
  el.style.display = 'block';
  setTimeout(() => { el.style.display = 'none'; }, 3000);
}

// ── EDITOR ──
const editor = document.getElementById('code-editor');

editor.addEventListener('input', () => {
  if (isUpdatingFromRemote) return;
  send({ type: 'code_change', code: editor.value });
  updateLineNumbers();
});

editor.addEventListener('keydown', (e) => {
  if (e.key === 'Tab') {
    e.preventDefault();
    const start = editor.selectionStart;
    const end = editor.selectionEnd;
    editor.value = editor.value.substring(0, start) + '  ' + editor.value.substring(end);
    editor.selectionStart = editor.selectionEnd = start + 2;
    send({ type: 'code_change', code: editor.value });
  }
});

editor.addEventListener('scroll', () => {
  document.getElementById('line-numbers').scrollTop = editor.scrollTop;
});

function updateLineNumbers() {
  const lines = editor.value.split('\n');
  const ln = document.getElementById('line-numbers');
  ln.innerHTML = lines.map((_, i) => `<span>${i + 1}</span>`).join('');
}

// ── LANGUAGE ──
function changeLanguage(lang) {
  send({ type: 'language_change', language: lang });
  updateLangTab(lang);
}

function updateLangTab(lang) {
  document.getElementById('lang-select').value = lang;
  const exts = { javascript: 'js', python: 'py', html: 'html', css: 'css', typescript: 'ts', json: 'json', bash: 'sh' };
  document.getElementById('file-tab').textContent = `main.${exts[lang] || lang}`;
}

// ── USERS ──
function updateUsers(users) {
  const list = document.getElementById('users-list');
  const topbar = document.getElementById('topbar-users');
  document.getElementById('user-count').textContent = users.length;

  list.innerHTML = users.map(u => {
    const color = getColor(u.id);
    const isMe = u.id === myId;
    return `<div class="user-entry">
      <div class="user-avatar" style="background:${color}22;color:${color}">${u.name[0].toUpperCase()}</div>
      <span class="user-name" style="color:${isMe ? color : ''}">${u.name}</span>
      ${isMe ? '<span class="user-you">you</span>' : ''}
    </div>`;
  }).join('');

  topbar.innerHTML = users.slice(0, 4).map(u => {
    const color = getColor(u.id);
    return `<div class="user-pill" style="border-color:${color};color:${color}">${u.name[0].toUpperCase()} ${u.name}</div>`;
  }).join('');
}

// ── TYPING INDICATOR ──
function showTypingIndicator(nameOrId) {
  const el = document.getElementById('typing-indicator');
  el.textContent = `${nameOrId} is typing...`;
  clearTimeout(window._typingTimer);
  window._typingTimer = setTimeout(() => { el.textContent = ''; }, 1500);
}

// ── CHAT ──
function chatKeydown(e) {
  if (e.key === 'Enter') sendChat();
}

function sendChat() {
  const input = document.getElementById('chat-input');
  const msg = input.value.trim();
  if (!msg) return;
  send({ type: 'chat', message: msg });
  input.value = '';
}

function addChatMsg(msg) {
  const container = document.getElementById('chat-messages');
  const color = getColor(msg.userId);
  const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  const el = document.createElement('div');
  el.className = 'chat-msg';
  el.innerHTML = `
    <div class="chat-msg-header">
      <span class="chat-msg-name" style="color:${color}">${msg.name}</span>
      <span class="chat-msg-time">${time}</span>
    </div>
    <div class="chat-msg-text">${escapeHtml(msg.message)}</div>`;
  container.appendChild(el);
  container.scrollTop = container.scrollHeight;
}

function addSystemMsg(text) {
  const container = document.getElementById('chat-messages');
  const el = document.createElement('div');
  el.className = 'chat-msg system';
  el.innerHTML = `<div class="chat-msg-text">${escapeHtml(text)}</div>`;
  container.appendChild(el);
  container.scrollTop = container.scrollHeight;
}

function escapeHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ── CODE RUNNER (JS only) ──
function runCode() {
  if (document.getElementById('lang-select').value !== 'javascript') {
    addOutput('⚠ Only JavaScript can run in the browser', 'error');
    return;
  }
  const code = editor.value;
  const logs = [];
  const origLog = console.log;
  const origErr = console.error;
  const origWarn = console.warn;

  console.log = (...a) => { logs.push({ text: a.map(String).join(' '), type: 'success' }); };
  console.error = (...a) => { logs.push({ text: a.map(String).join(' '), type: 'error' }); };
  console.warn = (...a) => { logs.push({ text: a.map(String).join(' '), type: 'info' }); };

  try {
    // eslint-disable-next-line no-new-func
    new Function(code)();
  } catch (e) {
    logs.push({ text: e.message, type: 'error' });
  }

  console.log = origLog;
  console.error = origErr;
  console.warn = origWarn;

  clearOutput();
  if (logs.length === 0) {
    addOutput('Executed with no output', 'info');
  } else {
    logs.forEach(l => addOutput(l.text, l.type));
  }
}

function addOutput(text, type = '') {
  const out = document.getElementById('output');
  const el = document.createElement('div');
  el.className = `out-line ${type}`;
  el.textContent = text;
  out.appendChild(el);
  out.scrollTop = out.scrollHeight;
}

function clearOutput() {
  document.getElementById('output').innerHTML = '';
}

// ── UTILS ──
function copyRoomId() {
  const id = document.getElementById('room-id-display').textContent;
  navigator.clipboard.writeText(id).then(() => showToast('Room code copied!'));
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

// Init
editor.addEventListener('input', updateLineNumbers);
updateLineNumbers();

// Enter key on landing
document.getElementById('username-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') createRoom();
});
document.getElementById('room-code-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') joinRoom();
});
</script>
</body>
</html>